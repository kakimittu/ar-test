<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>AR Editor Pro</title>

<style>
body {
  font-family: sans-serif;
  padding: 20px;
}

/* マーカー風背景 */
#previewArea {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 30px;
  height: 250px;
  border: 4px solid black;
  background: repeating-linear-gradient(
    45deg,
    #eee,
    #eee 10px,
    #ddd 10px,
    #ddd 20px
  );
}

/* 画像 */
.previewImg {
  margin: 0 10px;
  transition: 0.3s;
  cursor: pointer;
}

.small {
  width: 100px;
  transform: scale(0.7);
  opacity: 0.7;
}

.large {
  width: 160px;
  transform: scale(1.2);
  border: 3px solid red;
}

button {
  margin-top: 20px;
  padding: 10px 20px;
}
</style>
</head>

<body>

<h2>ARエディター（3枚）</h2>
<p>✔ 3枚選択 → ドラッグで並び替え → クリックで中央変更</p>

<input type="file" id="fileInput" accept="image/*" multiple>

<div id="previewArea"></div>

<button id="saveBtn">保存</button>

<br><br>
<a href="index.html">ARページへ戻る</a>

<script>
const fileInput = document.getElementById("fileInput");
const previewArea = document.getElementById("previewArea");

let imagesBase64 = [];
let centerIndex = 1; // 初期中央

/* ========= 画像圧縮 ========= */
function resizeImage(file, maxWidth = 800) {
  return new Promise((resolve) => {
    const reader = new FileReader();

    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement("canvas");
        const scale = maxWidth / img.width;
        canvas.width = maxWidth;
        canvas.height = img.height * scale;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        resolve(canvas.toDataURL("image/jpeg", 0.8));
      };
      img.src = e.target.result;
    };

    reader.readAsDataURL(file);
  });
}

/* ========= プレビュー更新 ========= */
function renderPreview() {
  previewArea.innerHTML = "";

  imagesBase64.forEach((src, index) => {
    const img = document.createElement("img");
    img.src = src;
    img.classList.add("previewImg");
    img.draggable = true;

    if (index === centerIndex) {
      img.classList.add("large");
    } else {
      img.classList.add("small");
    }

    /* 中央変更 */
    img.addEventListener("click", () => {
      centerIndex = index;
      renderPreview();
    });

    /* ドラッグ並び替え */
    img.addEventListener("dragstart", (e) => {
      e.dataTransfer.setData("index", index);
    });

    img.addEventListener("dragover", (e) => e.preventDefault());

    img.addEventListener("drop", (e) => {
      const fromIndex = e.dataTransfer.getData("index");
      const temp = imagesBase64[fromIndex];
      imagesBase64.splice(fromIndex, 1);
      imagesBase64.splice(index, 0, temp);
      centerIndex = 1;
      renderPreview();
    });

    previewArea.appendChild(img);
  });
}

/* ========= 画像選択 ========= */
fileInput.addEventListener("change", async (event) => {
  const files = event.target.files;

  if (files.length !== 3) {
    alert("必ず3枚選択してください");
    fileInput.value = "";
    return;
  }

  imagesBase64 = [];

  for (let file of files) {
    const resized = await resizeImage(file);
    imagesBase64.push(resized);
  }

  centerIndex = 1;
  renderPreview();
});

/* ========= 保存 ========= */
document.getElementById("saveBtn").addEventListener("click", () => {
  if (imagesBase64.length !== 3) {
    alert("3枚選択してください");
    return;
  }

  localStorage.setItem("arImages", JSON.stringify(imagesBase64));
  localStorage.setItem("centerIndex", centerIndex);

  alert("保存しました！");
});
</script>

</body>
</html>
