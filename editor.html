<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>AR Business Card Editor - Aspect Ratio Pro</title>
<style>
  body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #0a0a0a; color: #fff; text-align: center; margin: 0; padding: 20px; }
  #previewArea { 
    height: 300px; background: #111; border: 1px solid #333; margin: 20px auto; max-width: 500px;
    position: relative; display: flex; justify-content: center; align-items: center; border-radius: 15px;
  }
  #imgGroup { display: flex; gap: 10px; z-index: 10; }
  .previewImg { width: 80px; height: auto; border: 2px solid #00f2ff; border-radius: 4px; }
  .panel { background: #1a1a1a; padding: 20px; border-radius: 15px; max-width: 500px; margin: 0 auto; text-align: left; }
  input[type="range"] { width: 100%; accent-color: #00f2ff; }
  .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; }
  #saveBtn { background: #00f2ff; color: #000; }
</style>
</head>
<body>

<h3>AR PORTFOLIO CONFIG</h3>

<div id="previewArea">
  <div id="imgGroup"></div>
</div>

<div class="panel">
  <label>1. 画像を選択 (自動比率計算)</label>
  <input type="file" id="fileInput" accept="image/*" multiple>
  
  <label style="display:block; margin-top:15px;">2. 高さ調整</label>
  <input type="range" id="posY" min="0.5" max="3" step="0.1" value="1.2">
  
  <label style="display:block; margin-top:15px;">3. 画像同士の間隔</label>
  <input type="range" id="gap" min="50" max="300" step="10" value="120">
</div>

<button id="saveBtn" class="btn">CLOUD SAVE</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {  apiKey: "AIzaSyAHJPzHf4QR3V4GOcd0l3s-_VvSSYeWZAA",
  authDomain: "armisetai.firebaseapp.com",
  projectId: "armisetai",
  storageBucket: "armisetai.firebasestorage.app",
  messagingSenderId: "1006973944547",
  appId: "1:1006973944547:web:adc5e195039585bbdabbd6"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let imagesBase64 = [];
let imageRatios = []; // 比率を格納する配列

async function processImage(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const maxW = 800; // 幅を800pxに固定
        const ratio = img.height / img.width; // 比率計算
        canvas.width = maxW;
        canvas.height = maxW * ratio;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve({ data: canvas.toDataURL("image/jpeg", 0.7), ratio: ratio });
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

document.getElementById("fileInput").onchange = async (e) => {
  imagesBase64 = []; imageRatios = [];
  document.getElementById("imgGroup").innerHTML = "";
  for (let file of Array.from(e.target.files).slice(0, 3)) {
    const result = await processImage(file);
    imagesBase64.push(result.data);
    imageRatios.push(result.ratio);
    const imgEl = document.createElement("img");
    imgEl.src = result.data; imgEl.className = "previewImg";
    document.getElementById("imgGroup").appendChild(imgEl);
  }
};

document.getElementById("saveBtn").onclick = async () => {
  await setDoc(doc(db, "arData", "main"), {
    images: imagesBase64,
    ratios: imageRatios, // 比率データ
    transform: {
      position: `0 ${document.getElementById("posY").value} 0`,
      gap: document.getElementById("gap").value / 100
    }
  });
  alert("保存完了！");
};
</script>
</body>
</html>
