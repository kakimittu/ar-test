<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>AR PORTFOLIO EDITOR</title>
<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<style>
  body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: #111; color: #fff; }
  #controls { width: 350px; padding: 20px; background: #1a1a1a; overflow-y: auto; border-right: 1px solid #333; }
  #preview { flex-grow: 1; position: relative; }
  .input-group { margin-bottom: 20px; }
  label { display: block; margin-bottom: 8px; font-size: 14px; color: #aaa; }
  input[type="text"], input[type="file"] { width: 100%; padding: 10px; background: #333; border: 1px solid #444; color: #fff; border-radius: 5px; box-sizing: border-box; }
  .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
  #saveBtn { background: #00f2ff; color: #000; }
  .img-item { font-size: 12px; background: #333; padding: 5px; margin-top: 5px; border-radius: 3px; }
</style>
</head>
<body>

<div id="controls">
  <h2>AR EDITOR</h2>
  
  <div class="input-group">
    <label>ドキュメントID (名刺の識別子)</label>
    <input type="text" id="markerId" placeholder="例: akazawa" value="akazawa">
  </div>

  <div class="input-group">
    <label>画像を選択 (複数可/自動比率計算)</label>
    <input type="file" id="fileInput" accept="image/*" multiple>
    <div id="fileList"></div>
  </div>

  <div class="input-group">
    <label>名前 (AKAZAWA YUKO等)</label>
    <input type="text" id="nameInput" value="AKAZAWA YUKO">
  </div>

  <div class="input-group">
    <label>肩書き (HORSE TRAINER等)</label>
    <input type="text" id="jobInput" value="HORSE TRAINER">
  </div>

  <button id="saveBtn" class="btn">FIRESTOREへ保存</button>
</div>

<div id="preview">
  <a-scene embedded vr-mode-ui="enabled: false">
    <a-sky color="#222"></a-sky>
    <a-entity id="ar-root" position="0 0 -3" rotation="20 0 0">
      <a-plane color="#ff9900" width="2.2" height="1.4" position="0 0 0" rotation="-90 0 0" material="opacity: 0.3; transparent: true;"></a-plane>
      <a-circle radius="0.1" color="#ff8c00" position="-1.4 0.1 0.6" rotation="-90 0 0"></a-circle>
      <a-circle radius="0.1" color="#ff4500" position="1.4 0.1 0.6" rotation="-90 0 0"></a-circle>
      
      <a-entity id="preview-container"></a-entity>
    </a-entity>
    <a-entity camera position="0 1.6 0"></a-entity>
  </a-scene>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyAHJPzHf4QR3V4GOcd0l3s-_VvSSYeWZAA",
    authDomain: "armisetai.firebaseapp.com",
    projectId: "armisetai",
    storageBucket: "armisetai.firebasestorage.app",
    messagingSenderId: "1006973944547",
    appId: "1:1006973944547:web:adc5e195039585bbdabbd6"
  }; // APIキーを貼ってください
  
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let imagesBase64 = [];
let imageRatios = [];

// 画像処理
document.getElementById("fileInput").onchange = async (e) => {
  imagesBase64 = []; imageRatios = [];
  const files = Array.from(e.target.files);
  const listEl = document.getElementById("fileList");
  listEl.innerHTML = "";

  for (let file of files) {
    const result = await processImage(file);
    imagesBase64.push(result.data);
    imageRatios.push(result.ratio);
    listEl.innerHTML += `<div class="img-item">${file.name} (比率: ${result.ratio.toFixed(2)})</div>`;
  }
  updatePreview();
};

async function processImage(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const maxW = 800;
        const ratio = img.height / img.width;
        canvas.width = maxW; canvas.height = maxW * ratio;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve({ data: canvas.toDataURL("image/jpeg", 0.7), ratio: ratio });
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function updatePreview() {
  const container = document.getElementById("preview-container");
  container.innerHTML = "";
  if(imagesBase64.length === 0) return;

  // プレビュー用に最初の1枚だけ表示
  const aImg = document.createElement("a-image");
  aImg.setAttribute("src", imagesBase64[0]);
  aImg.setAttribute("rotation", "-90 0 0");
  aImg.setAttribute("position", "0 0.2 0");
  aImg.setAttribute("width", 1.6);
  aImg.setAttribute("height", 1.6 * imageRatios[0]);
  container.appendChild(aImg);

  const nameText = document.createElement("a-text");
  nameText.setAttribute("value", document.getElementById("nameInput").value);
  nameText.setAttribute("align", "center");
  nameText.setAttribute("position", "0 0.1 -1.1");
  nameText.setAttribute("rotation", "-90 0 0");
  nameText.setAttribute("width", 3);
  container.appendChild(nameText);
}

document.getElementById("saveBtn").onclick = async () => {
  const markerId = document.getElementById("markerId").value;
  if(!markerId) return alert("IDを入力してください");

  await setDoc(doc(db, "arUsers", markerId), {
    images: imagesBase64,
    ratios: imageRatios,
    name: document.getElementById("nameInput").value,
    job: document.getElementById("jobInput").value
  });
  alert(markerId + " のデータを保存しました！");
};
</script>
</body>
</html>
