　<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>AR Pro Editor</title>

<style>
body{background:#0a0a0a;color:#fff;text-align:center;font-family:Arial;padding:20px;}

#previewArea{
  height:350px;
  background:#111;
  border-radius:15px;
  position:relative;
  max-width:600px;
  margin:20px auto;
  overflow:hidden;
}

.previewImg{
  position:absolute;
  border:2px solid #00f2ff;
  border-radius:8px;
  transition:0.3s;
}

.panel{
  background:#1a1a1a;
  padding:20px;
  border-radius:15px;
  max-width:600px;
  margin:0 auto;
  text-align:left;
}

input[type="range"]{width:100%;}
.btn{width:100%;padding:15px;border:none;border-radius:8px;margin-top:15px;font-weight:bold;cursor:pointer;}
#saveBtn{background:#00f2ff;color:#000;}
</style>
</head>

<body>

<h3>AR ADVANCED CONFIG</h3>

<input type="text" id="markerName" placeholder="マーカー名">

<div id="previewArea"></div>

<div class="panel">

<label>画像選択（最大3枚）</label>
<input type="file" id="fileInput" accept="image/*" multiple>

<label style="margin-top:15px;">円の半径</label>
<input type="range" id="radius" min="50" max="200" step="10" value="120">

<label style="margin-top:15px;">サイズ</label>
<input type="range" id="scale" min="0.3" max="2" step="0.1" value="1">

<label style="margin-top:15px;">Y補正（全体上下）</label>
<input type="range" id="globalY" min="-100" max="100" step="10" value="0">

</div>

<button id="saveBtn" class="btn">保存</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey: "AIzaSyAHJPzHf4QR3V4GOcd0l3s-_VvSSYeWZAA",
  authDomain: "armisetai.firebaseapp.com",
  projectId: "armisetai",
  storageBucket: "armisetai.firebasestorage.app",
  messagingSenderId: "1006973944547",
  appId: "1:1006973944547:web:adc5e195039585bbdabbd6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let images=[];
let ratios=[];
let individualData=[];

async function processImage(file){
  return new Promise(resolve=>{
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const canvas=document.createElement("canvas");
        const maxW=800;
        const ratio=img.height/img.width;
        canvas.width=maxW;
        canvas.height=maxW*ratio;
        canvas.getContext("2d").drawImage(img,0,0,canvas.width,canvas.height);
        resolve({data:canvas.toDataURL("image/jpeg",0.7),ratio});
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function renderPreview(){
  const area=document.getElementById("previewArea");
  area.innerHTML="";

  const radius=parseInt(document.getElementById("radius").value);
  const scale=parseFloat(document.getElementById("scale").value);
  const globalY=parseInt(document.getElementById("globalY").value);

  const centerX=300;
  const centerY=160+globalY;

  images.forEach((src,i)=>{
    const angle=(i/images.length)*Math.PI*2;
    const x=centerX + radius*Math.cos(angle);
    const y=centerY + radius*Math.sin(angle);

    const img=document.createElement("img");
    img.src=src;
    img.className="previewImg";

    const baseW=100*scale;
    img.style.width=baseW+"px";
    img.style.height=(baseW*ratios[i])+"px";

    img.style.left=(x)+"px";
    img.style.top=(y + Math.sin(Date.now()/500 + i)*10)+"px";

    area.appendChild(img);

    individualData[i]={
      angle:angle,
      radius:radius
    };
  });
}

document.getElementById("fileInput").onchange=async(e)=>{
  images=[];ratios=[];individualData=[];
  for(let file of Array.from(e.target.files).slice(0,3)){
    const result=await processImage(file);
    images.push(result.data);
    ratios.push(result.ratio);
  }
  renderPreview();
};

document.getElementById("radius").oninput=renderPreview;
document.getElementById("scale").oninput=renderPreview;
document.getElementById("globalY").oninput=renderPreview;

setInterval(renderPreview,50); // ふわふわアニメーション

document.getElementById("saveBtn").onclick=async()=>{
  const markerName=document.getElementById("markerName").value.trim();
  if(!markerName){alert("マーカー名を入力");return;}

  await setDoc(doc(db,"arData",markerName),{
    images:images,
    ratios:ratios,
    layout:{
      type:"circle",
      radius:document.getElementById("radius").value,
      scale:document.getElementById("scale").value,
      globalY:document.getElementById("globalY").value
    },
    individual:individualData
  });

  alert("保存完了");
};
</script>

</body>
</html>
