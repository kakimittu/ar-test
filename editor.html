<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>AR PORTFOLIO EDITOR - FINAL</title>
<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<style>
  body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: #0f0f0f; color: #fff; overflow: hidden; }
  #controls { width: 380px; padding: 20px; background: #1a1a1a; overflow-y: auto; border-right: 1px solid #333; z-index: 100; box-sizing: border-box; }
  #preview { flex-grow: 1; background: #000; position: relative; }
  .input-group { margin-bottom: 20px; padding: 15px; background: #262626; border-radius: 8px; border-left: 4px solid #00f2ff; }
  label { display: block; margin-bottom: 5px; font-size: 12px; color: #00f2ff; font-weight: bold; }
  input[type="text"], input[type="file"] { width: 100%; padding: 10px; background: #333; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
  .btn { width: 100%; padding: 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; background: #00f2ff; color: #000; font-size: 16px; }
  .image-setting-card { background: #111; padding: 10px; margin-top: 10px; border-radius: 4px; border: 1px solid #333; font-size: 12px; }
  .image-setting-card img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-bottom: 5px; }
</style>
</head>
<body>

<div id="controls">
  <h2>AR EDITOR</h2>
  <div class="input-group">
    <label>① ドキュメントID</label>
    <input type="text" id="markerId" value="akazawa">
    <label>② マーカーパス (.patt)</label>
    <input type="text" id="pattInput" value="assets/markers/pattern-AKA2.patt">
  </div>
  <div class="input-group">
    <label>③ 画像とテキスト</label>
    <input type="file" id="fileInput" accept="image/*" multiple>
    <div id="dynamic-inputs"></div>
  </div>
  <button id="saveBtn" class="btn">保存して公開</button>
</div>

<div id="preview">
  <a-scene embedded vr-mode-ui="enabled: false">
    <a-entity id="rig" position="0 6 0" rotation="-90 0 0">
      <a-entity camera></a-entity>
    </a-entity>
    <a-light type="ambient" intensity="1.2"></a-light>
    <a-entity id="dynamic-content"></a-entity>
  </a-scene>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAHJPzHf4QR3V4GOcd0l3s-_VvSSYeWZAA",
  authDomain: "armisetai.firebaseapp.com",
  projectId: "armisetai",
  storageBucket: "armisetai.firebasestorage.app",
  messagingSenderId: "1006973944547",
  appId: "1:1006973944547:web:adc5e195039585bbdabbd6"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let imagesBase64 = [];
let imageRatios = [];
// 最も安定している日本語フォントURL
const FONT_URL = "https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/notosansjp/NotoSansJP-Medium.json";

document.getElementById("fileInput").onchange = async (e) => {
  imagesBase64 = []; imageRatios = [];
  const files = Array.from(e.target.files);
  const container = document.getElementById("dynamic-inputs");
  container.innerHTML = "";

  for (let i = 0; i < files.length; i++) {
    const res = await processImage(files[i]);
    imagesBase64.push(res.data);
    imageRatios.push(res.ratio);

    const card = document.createElement("div");
    card.className = "image-setting-card";
    card.innerHTML = `
      <img src="${res.data}"><br>
      <input type="text" class="name-input" placeholder="タイトル" value="タイトル ${i+1}">
      <input type="text" class="job-input" placeholder="説明文" value="説明文 ${i+1}">
    `;
    container.appendChild(card);
  }
  document.querySelectorAll("input").forEach(el => el.oninput = updatePreview);
  updatePreview();
};

async function processImage(file) {
  return new Promise(resolve => {
    const r = new FileReader();
    r.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const ratio = img.height / img.width;
        canvas.width = 800; canvas.height = 800 * ratio;
        canvas.getContext("2d").drawImage(img, 0, 0, 800, 800 * ratio);
        resolve({ data: canvas.toDataURL("image/jpeg", 0.7), ratio: ratio });
      };
      img.src = e.target.result;
    };
    r.readAsDataURL(file);
  });
}

function updatePreview() {
  const stage = document.getElementById("dynamic-content");
  stage.innerHTML = "";
  const names = document.querySelectorAll(".name-input");
  const jobs = document.querySelectorAll(".job-input");

  imagesBase64.forEach((img, i) => {
    const ent = document.createElement("a-entity");
    ent.setAttribute("position", `${i * 4} 0 0`);

    const aImg = document.createElement("a-image");
    aImg.setAttribute("src", img);
    aImg.setAttribute("width", 2.5);
    aImg.setAttribute("height", 2.5 * imageRatios[i]);
    ent.appendChild(aImg);

    const t1 = document.createElement("a-text");
    t1.setAttribute("value", names[i]?.value || "");
    t1.setAttribute("font", FONT_URL);
    t1.setAttribute("shader", "msdf");
    t1.setAttribute("negate", "false");
    t1.setAttribute("align", "center");
    t1.setAttribute("position", `0 ${(2.5 * imageRatios[i] / 2) + 0.4} 0.05`);
    t1.setAttribute("width", 5);
    ent.appendChild(t1);

    const t2 = document.createElement("a-text");
    t2.setAttribute("value", jobs[i]?.value || "");
    t2.setAttribute("font", FONT_URL);
    t2.setAttribute("shader", "msdf");
    t2.setAttribute("negate", "false");
    t2.setAttribute("align", "center");
    t2.setAttribute("color", "#ffcc00");
    t2.setAttribute("position", `0 -${(2.5 * imageRatios[i] / 2) + 0.4} 0.05`);
    t2.setAttribute("width", 3.5);
    ent.appendChild(t2);

    stage.appendChild(ent);
  });
}

document.getElementById("saveBtn").onclick = async () => {
  const id = document.getElementById("markerId").value;
  const names = Array.from(document.querySelectorAll(".name-input")).map(el => el.value);
  const jobs = Array.from(document.querySelectorAll(".job-input")).map(el => el.value);
  try {
    await setDoc(doc(db, "arUsers", id), {
      images: imagesBase64,
      ratios: imageRatios,
      names: names,
      jobs: jobs,
      pattUrl: document.getElementById("pattInput").value
    });
    alert("保存成功！");
  } catch (e) { alert(e.message); }
};
</script>
</body>
</html>
