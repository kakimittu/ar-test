<!DOCTYPE html>
<html lang="ja">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AR Editor Pro</title>

<style>
body {
  font-family: sans-serif;
  padding: 20px;
  text-align: center;
}

/* 背景 */
#previewArea {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 30px;
  height: 300px;
  border: 4px solid black;
  background: repeating-linear-gradient(
    45deg,
    #eee,
    #eee 10px,
    #ddd 10px,
    #ddd 20px
  );
  perspective: 800px;
}

/* 共通画像 */
.previewImg {
  margin: 0 10px;
  transition: 0.4s;
  cursor: pointer;
  border-radius: 10px;
  box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}

/* 左右 */
.smallLeft {
  width: 130px;
  transform: rotateY(25deg) scale(0.9);
  opacity: 0.7;
}

.smallRight {
  width: 130px;
  transform: rotateY(-25deg) scale(0.9);
  opacity: 0.7;
}

/* 中央 */
.large {
  width: 220px;
  transform: scale(1.2);
  border: 4px solid red;
  z-index: 10;
}

button {
  margin-top: 20px;
  padding: 12px 25px;
  font-size: 16px;
  border-radius: 8px;
}
</style>
</head>

<body>

<h2>ARエディター（3枚）</h2>
<p>✔ 3枚選択 → クリックで中央変更</p>

<input type="file" id="fileInput" accept="image/*" multiple>

<div id="previewArea"></div>

<button id="saveBtn">保存</button>

<br><br>
<a href="index.html">ARページへ戻る</a>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "armisetai.firebaseapp.com",
  projectId: "armisetai",
  storageBucket: "armisetai.firebasestorage.app",
  messagingSenderId: "1006973944547",
  appId: "1:1006973944547:web:adc5e195039585bbdabbd6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

const fileInput = document.getElementById("fileInput");
const previewArea = document.getElementById("previewArea");

let imagesBase64 = [];
let centerIndex = 1;

function resizeImage(file, maxWidth = 1000) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement("canvas");
        const scale = maxWidth / img.width;
        canvas.width = maxWidth;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL("image/jpeg", 0.85));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function renderPreview() {
  previewArea.innerHTML = "";

  imagesBase64.forEach((src, index) => {
    const img = document.createElement("img");
    img.src = src;
    img.classList.add("previewImg");

    if (index === centerIndex) {
      img.classList.add("large");
    } else if (index < centerIndex) {
      img.classList.add("smallLeft");
    } else {
      img.classList.add("smallRight");
    }

    img.onclick = () => {
      centerIndex = index;
      renderPreview();
    };

    previewArea.appendChild(img);
  });
}

fileInput.addEventListener("change", async (event) => {
  const files = event.target.files;

  if (files.length !== 3) {
    alert("必ず3枚選択してください");
    return;
  }

  imagesBase64 = [];

  for (let file of files) {
    const resized = await resizeImage(file);
    imagesBase64.push(resized);
  }

  renderPreview();
});

document.getElementById("saveBtn").addEventListener("click", async () => {
  if (imagesBase64.length !== 3) {
    alert("3枚選択してください");
    return;
  }

  let imageUrls = [];

  for (let i = 0; i < imagesBase64.length; i++) {
    const blob = await (await fetch(imagesBase64[i])).blob();
    const storageRef = ref(storage, "arImages/image_" + i + "_" + Date.now() + ".jpg");

    await uploadBytes(storageRef, blob);
    const url = await getDownloadURL(storageRef);
    imageUrls.push(url);
  }

  await setDoc(doc(db, "arData", "main"), {
    images: imageUrls,
    centerIndex: centerIndex
  });

  alert("Storageに保存しました！");
});

</script>

</body>
</html>
