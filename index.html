<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR PORTFOLIO PLAYER</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">
    <a-marker type="pattern" url="assets/markers/pattern-AKA2.patt" id="mainMarker">
      </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAHJPzHf4QR3V4GOcd0l3s-_VvSSYeWZAA",
  authDomain: "armisetai.firebaseapp.com",
  projectId: "armisetai",
  storageBucket: "armisetai.firebasestorage.app",
  messagingSenderId: "1006973944547",
  appId: "1:1006973944547:web:adc5e195039585bbdabbd6"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const markerId = urlParams.get('id') || 'akazawa';
const marker = document.getElementById("mainMarker");
const FONT_URL = "https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/notosansjp/NotoSansJP-Medium.json";

let items = [];
let currentIndex = 0;

onSnapshot(doc(db, "arUsers", markerId), (snap) => {
  if (!snap.exists()) return;
  const data = snap.snap.data();
  if (data.pattUrl) marker.setAttribute("url", data.pattUrl);

  marker.innerHTML = "";
  items = [];

  const imgs = data.images || [];
  const names = data.names || [];
  const jobs = data.jobs || [];

  imgs.forEach((src, i) => {
    const ent = document.createElement("a-entity");
    ent.setAttribute("visible", "false");

    const img = document.createElement("a-image");
    img.setAttribute("src", src);
    img.setAttribute("rotation", "-90 0 0");
    img.setAttribute("width", 2);
    img.setAttribute("height", 2 * (data.ratios[i] || 1));
    ent.appendChild(img);

    const t1 = document.createElement("a-text");
    t1.setAttribute("value", names[i] || "");
    t1.setAttribute("font", FONT_URL);
    t1.setAttribute("shader", "msdf");
    t1.setAttribute("negate", "false");
    t1.setAttribute("align", "center");
    t1.setAttribute("position", "0 0.2 -1.5");
    t1.setAttribute("rotation", "-90 0 0");
    t1.setAttribute("width", 4);
    ent.appendChild(t1);

    const t2 = document.createElement("a-text");
    t2.setAttribute("value", jobs[i] || "");
    t2.setAttribute("font", FONT_URL);
    t2.setAttribute("shader", "msdf");
    t2.setAttribute("negate", "false");
    t2.setAttribute("align", "center");
    t2.setAttribute("color", "#ffcc00");
    t2.setAttribute("position", "0 0.2 1.5");
    t2.setAttribute("rotation", "-90 0 0");
    t2.setAttribute("width", 3);
    ent.appendChild(t2);

    marker.appendChild(ent);
    items.push(ent);
  });
  updateDisplay();
});

function updateDisplay() {
  items.forEach((item, i) => {
    item.setAttribute("visible", i === currentIndex);
  });
}

// 5秒ごとに自動切り替え
setInterval(() => {
  if (items.length > 0) {
    currentIndex = (currentIndex + 1) % items.length;
    updateDisplay();
  }
},3000);
</script>
</body>
</html>
