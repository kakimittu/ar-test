<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>AR Image Switch</title>

<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

<style>
body {
  margin: 0;
  overflow: hidden;
}

#nextBtn2D {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 15px 20px;
  font-size: 16px;
  background: blue;
  color: white;
  border: none;
  border-radius: 10px;
  z-index: 9999;
}

#prevBtn2D {
  position: fixed;
  bottom: 20px;
  left: 20px;
  padding: 15px 20px;
  font-size: 16px;
  background: gray;
  color: white;
  border: none;
  border-radius: 10px;
  z-index: 9999;
}
</style>
</head>

<body>

<a-scene
  embedded
  arjs="sourceType: webcam; debugUIEnabled: false;"
  vr-mode-ui="enabled: false"
>

  <a-assets id="assets"></a-assets>

  <a-marker
    id="marker"
    type="pattern"
    url="assets/markers/pattern-AKA2.patt"
  ></a-marker>

  <a-entity camera></a-entity>

</a-scene>

<button id="prevBtn2D">◀ 前へ</button>
<button id="nextBtn2D">次へ ▶</button>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAHJPzHf4QR3V4GOcd0l3s-_VvSSYeWZAA",
    authDomain: "armisetai.firebaseapp.com",
    projectId: "armisetai",
    storageBucket: "armisetai.firebasestorage.app",
    messagingSenderId: "1006973944547",
    appId: "1:1006973944547:web:adc5e195039585bbdabbd6"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
　const db = getFirestore(app);

/* ===== 既存の画像処理ロジック ===== */

const fileInput = document.getElementById("fileInput");
const previewArea = document.getElementById("previewArea");

let imagesBase64 = [];
let centerIndex = 1;

function resizeImage(file, maxWidth = 800) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement("canvas");
        const scale = maxWidth / img.width;
        canvas.width = maxWidth;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL("image/jpeg", 0.8));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function renderPreview() {
  previewArea.innerHTML = "";

  imagesBase64.forEach((src, index) => {
    const img = document.createElement("img");
    img.src = src;
    img.draggable = true;

    if (index === centerIndex) {
      img.style.width = "160px";
      img.style.border = "3px solid red";
    } else {
      img.style.width = "100px";
      img.style.opacity = "0.6";
    }

    img.onclick = () => {
      centerIndex = index;
      renderPreview();
    };

    previewArea.appendChild(img);
  });
}

fileInput.addEventListener("change", async (event) => {
  const files = event.target.files;

  if (files.length !== 3) {
    alert("必ず3枚選択してください");
    return;
  }

  imagesBase64 = [];

  for (let file of files) {
    const resized = await resizeImage(file);
    imagesBase64.push(resized);
  }

  renderPreview();
});

/* ===== Firebase保存 ===== */

document.getElementById("saveBtn").addEventListener("click", async () => {
  if (imagesBase64.length !== 3) {
    alert("3枚選択してください");
    return;
  }

  await setDoc(doc(db, "arData", "main"), {
    images: imagesBase64,
    centerIndex: centerIndex
  });

  alert("Firebaseに保存しました！");
});

</script>


</body>
</html>

